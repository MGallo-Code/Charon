// smtp.go
//
// Mailer interface and SMTPMailer implementation.
// Add other implementations (ses.go, etc.) as separate files in this package.
package mail

import (
	"context"
	"fmt"
	"net/smtp"
)

// Mailer sends transactional emails.
type Mailer interface {
	// SendPasswordReset sends a password reset email containing the raw token.
	SendPasswordReset(ctx context.Context, toEmail, token string) error
}

// SMTPMailer sends transactional email via SMTP.
// Compatible with any SMTP provider: SES, Mailgun, Mailpit (local dev), etc.
type SMTPMailer struct {
	host         string
	port         string
	username     string
	password     string
	fromAddress  string
	resetURLBase string
}

// NewSMTPMailer creates an SMTPMailer with the given credentials.
func NewSMTPMailer(host, port, username, password, fromAddress, resetURLBase string) *SMTPMailer {
	return &SMTPMailer{
		host:         host,
		port:         port,
		username:     username,
		password:     password,
		fromAddress:  fromAddress,
		resetURLBase: resetURLBase,
	}
}

// SendPasswordReset emails a password reset link to toEmail.
// token is the raw (unhashed) token generated by the handler.
func (m *SMTPMailer) SendPasswordReset(_ context.Context, toEmail, token string) error {
	resetURL := m.resetURLBase + "?token=" + token

	body := "You requested a password reset.\n\n" +
		"Click the link below to choose a new password:\n\n" +
		resetURL + "\n\n" +
		"This link expires in 1 hour. If you did not request a reset, ignore this email."

	msg := "From: " + m.fromAddress + "\r\n" +
		"To: " + toEmail + "\r\n" +
		"Subject: Reset your password\r\n" +
		"MIME-Version: 1.0\r\n" +
		"Content-Type: text/plain; charset=UTF-8\r\n" +
		"\r\n" +
		body

	// Fourth arg to PlainAuth is host only (no port) -- used for SASL negotiation.
	auth := smtp.PlainAuth("", m.username, m.password, m.host)
	if err := smtp.SendMail(m.host+":"+m.port, auth, m.fromAddress, []string{toEmail}, []byte(msg)); err != nil {
		return fmt.Errorf("sending password reset email: %w", err)
	}
	return nil
}
